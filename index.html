<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title> Genetic Testing: 3D protein Viewer</title>
    <script src="https://3dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;700&display=swap" rel="stylesheet"/>
    <style>
        body {
            background-color: #fafafa;
            font-family: 'Figtree', sans-serif;
        }
        .viewer {
            height: 500px;
            width: 100%;
            border-radius: 20px;
            background-color: #fff;
        }
        .btn-custom {
            margin-top: 10px;
            width: 100%;
            font-family: inherit;
        }
        h3 {
            color: #424242;
        }
        .big-blue-text {
            font-family: inherit;
            font-size: 1.2em;
            color: #1e88e5;
        }
        .patient-select {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h3 class="center-align"><b>Genetic testing: </b> Mitochondrial protein</h3>

    <div class="row">
        <!-- Left: Original / Wildtype Protein (loads 1P32.pdb) -->
        <div class="col s12 m6">
            <div class="card">
                <div class="card-content">
                    <div id="viewerOriginal" class="viewer"></div>
                    <h3>Original Protein</h3>
                    <p>This is a mitochondrial matrix protein, which is crucial for energy production.</p>
                </div>
                <div class="card-action">
                    <button class="btn waves-effect waves-light btn-custom blue" id="resetOriginalBtn">Reset protein</button>
                    <button class="btn waves-effect waves-light btn-custom blue darken-2" id="toggleOriginalStyleBtn">Toggle structure/spacefill</button>
                </div>
            </div>
        </div>

        <!-- Right: Patient / Mutant Protein (starts blank until selection) -->
        <div class="col s12 m6">
            <div class="card">
                <div class="card-content">
                    <div id="viewerMutant" class="viewer"></div>
                    <h3>Patient Protein</h3>
                    
                    <!-- Dropdown added here so it stays within the original layout -->
                    <div class="input-field patient-select">
                        <select id="patientSelect">
                            <option value="" selected>-- Select a patient (load PDB) --</option>
                            <option value="priya">Patient 1: Priya</option>
                            <option value="tom">Patient 2: Tom</option>
                            <option value="phil">Patient 3: Phil</option>
                        </select>
                        <label>Load patient structure</label>
                    </div>

                </div>
                <div class="card-action">
                    <button class="btn waves-effect waves-light btn-custom blue" id="resetMutantBtn">Reset Protein</button>
                    <button class="btn waves-effect waves-light btn-custom blue darken-2" id="toggleMutantStyleBtn">Toggle structure</button>
                    <button class="btn waves-effect waves-light btn-custom red" id="highlightMutationsBtn">Highlight Mutations</button>
                </div>
            </div>
        </div>
    </div>

    <p class="center-align big-blue-text">How might the mutation impact the ability of this protein to do its job?</p>
</div>

<script>
    // PDB mapping
    const pdbUrls = {
        wildtype: "https://files.rcsb.org/download/1P32.pdb", // right viewer
        priya: "https://files.rcsb.org/download/8P8X.pdb",
        tom:   "https://files.rcsb.org/download/6RUP.pdb",
        phil:  "https://files.rcsb.org/download/7TE3.pdb"
    };

    // Mutation data: specify which residues are mutated for each patient
    const mutationData = {
        priya: [10, 25, 42, 58, 73],
        tom: [15, 31, 47, 64, 89],
        phil: [12]
    };

    let currentPatient = null;
    let mutationsHighlighted = false;
    let rotationSynced = false;
    let syncRotationInterval = null;

    // 3Dmol viewers
    let mutantViewer = null;   // left viewer (patient)
    let originalViewer = null; // right viewer (wildtype)
    let rotateMutantInterval = null;
    let rotateOriginalInterval = null;

    // styles
    let currentStyleMutant = 'spectrum';
    let currentStyleOriginal = 'spectrum';
    const spectrumStyle = { cartoon: { color: 'spectrum' } };
    const spacefillStyle = { sphere:  { color: 'spectrum' } };
    const greyStyle = { cartoon: { color: 'grey' } };
    const redStyle = { cartoon: { color: 'red' } };

    // create empty viewers first (no model for mutant initially)
    function initViewers() {
        mutantViewer = $3Dmol.createViewer("viewerMutant", { backgroundColor: '0xffffff' });
        originalViewer = $3Dmol.createViewer("viewerOriginal", { backgroundColor: '0xffffff' });

        // load the wildtype in the originalViewer
        fetchAndLoadPDB(originalViewer, pdbUrls.wildtype, spectrumStyle)
            .then(() => {
                originalViewer.zoomTo();
                originalViewer.render();
                startRotation(); // start rotation after original is loaded
            })
            .catch(err => console.error("Failed to load wildtype PDB:", err));
    }

    // fetch PDB text and add model to a viewer (clears previous models first)
    function fetchAndLoadPDB(viewer, pdbUrl, style) {
        return fetch(pdbUrl)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.text();
            })
            .then(pdbText => {
                viewer.clear(); // remove any existing models
                viewer.addModel(pdbText, 'pdb');
                viewer.setStyle({}, style);
                viewer.zoomTo();
                viewer.render();
            });
    }

    // rotation utilities
    function autoRotate(viewer, speedX = 0.2, speedY = 0.1) {
        if (!viewer) return null;
        return setInterval(() => {
            try {
                viewer.rotate(speedX, 'y');
                viewer.rotate(speedY, 'x');
                viewer.render();
            } catch (e) {
                // ignore if viewer is mid-update
            }
        }, 100);
    }

    function startRotation() {
        if (originalViewer) {
            if (rotateOriginalInterval) clearInterval(rotateOriginalInterval);
            rotateOriginalInterval = autoRotate(originalViewer, 0.15, 0.08);
        }
        if (mutantViewer) {
            if (rotateMutantInterval) clearInterval(rotateMutantInterval);
            rotateMutantInterval = autoRotate(mutantViewer, 0.15, 0.08);
        }
    }

    // dropdown handler: load selected patient PDB into left viewer
    function setupPatientDropdown() {
        const select = document.getElementById('patientSelect');

        // Materialize select initialization handled on window load below
        // but attach a plain JS change listener too (more reliable)
        select.addEventListener('change', async (e) => {
            const val = e.target.value;
            if (!val) return;

            currentPatient = val;
            mutationsHighlighted = false; // reset highlighting flag
            document.getElementById('highlightMutationsBtn').textContent = 'Highlight Mutations';

            const url = pdbUrls[val];
            if (!url) {
                console.error("No PDB URL for:", val);
                return;
            }

            try {
                await fetchAndLoadPDB(mutantViewer, url, spectrumStyle);
                // ensure rotation is running for mutant
                if (rotateMutantInterval) clearInterval(rotateMutantInterval);
                rotateMutantInterval = autoRotate(mutantViewer, 0.15, 0.08);
            } catch (err) {
                console.error("Error loading patient PDB:", err);
                M.toast({html: 'Error loading structure â€” check console.'});
            }
        });
    }

    // button bindings
    function setupButtons() {
        document.getElementById('resetMutantBtn').addEventListener('click', () => {
            if (mutantViewer) {
                // Reset highlighting if active
                if (mutationsHighlighted) {
                    mutantViewer.setStyle({}, spectrumStyle);
                    mutationsHighlighted = false;
                    document.getElementById('highlightMutationsBtn').textContent = 'Highlight Mutations';
                }
                mutantViewer.zoomTo();
                mutantViewer.render();
            }
        });
        document.getElementById('resetOriginalBtn').addEventListener('click', () => {
            if (originalViewer) {
                originalViewer.zoomTo();
                originalViewer.render();
            }
        });

        document.getElementById('toggleMutantStyleBtn').addEventListener('click', () => {
            currentStyleMutant = currentStyleMutant === 'spectrum' ? 'spacefill' : 'spectrum';
            const style = currentStyleMutant === 'spectrum' ? spectrumStyle : spacefillStyle;
            if (mutantViewer) {
                mutantViewer.setStyle({}, style);
                mutantViewer.render();
            }
        });

        document.getElementById('toggleOriginalStyleBtn').addEventListener('click', () => {
            currentStyleOriginal = currentStyleOriginal === 'spectrum' ? 'spacefill' : 'spectrum';
            const style = currentStyleOriginal === 'spectrum' ? spectrumStyle : spacefillStyle;
            if (originalViewer) {
                originalViewer.setStyle({}, style);
                originalViewer.render();
            }
        });

        document.getElementById('highlightMutationsBtn').addEventListener('click', () => {
            if (!currentPatient) {
                M.toast({html: 'Please select a patient first'});
                return;
            }

            const mutations = mutationData[currentPatient];
            if (!mutations) {
                M.toast({html: 'No mutation data for this patient'});
                return;
            }

            if (mutationsHighlighted) {
                // Toggle OFF: restore original spectrum style
                if (mutantViewer) {
                    mutantViewer.setStyle({}, spectrumStyle);
                    mutantViewer.render();
                }
                mutationsHighlighted = false;
                document.getElementById('highlightMutationsBtn').textContent = 'Highlight Mutations';
            } else {
                // Toggle ON: grey out all, highlight mutations in red
                if (mutantViewer) {
                    // First, set everything to grey
                    mutantViewer.setStyle({}, greyStyle);
                    // Then, color mutated residues in red
                    mutations.forEach(resi => {
                        mutantViewer.setStyle({resi: resi}, redStyle);
                    });
                    mutantViewer.render();
                }
                mutationsHighlighted = true;
                document.getElementById('highlightMutationsBtn').textContent = 'Hide Mutations';
            }
        });
    }

    // Initialization on window load
    window.addEventListener('load', () => {
        initViewers();

        // Initialize Materialize select and attach handler
        const elems = document.querySelectorAll('select');
        M.FormSelect.init(elems);
        setupPatientDropdown();

        setupButtons();
    });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>
